# Agent Guidelines for this Repository (Infrastructure)

## 1. Project Overview & Philosophy
This repository serves as the **"Single Source of Truth"** for a homelab server setup. It replaces tools like CasaOS with a Git-managed, Docker-based infrastructure.
- **Goal**: Full system restoration from this repo + one script.
- **Scope**: Docker orchestration, network configuration (Traefik), and system setup.
- **Exclusions**: Source code of custom apps (treated as black boxes/images), heavy data (media), and secrets (`.env`).

## 2. Directory Structure
- **dapps/**: Decentralized/Dockerized Applications. One folder per service (e.g., `dapps/jellyfin/`).
- **infra/**: Core infrastructure services (Traefik, Portainer, Databases).
- **devops/**: Maintenance and CI/CD tools.
- **install.sh**: The bootstrap script for setting up a fresh server.

## 3. Docker Compose Standards
*All services must use `docker-compose.yml` (or `.yaml`).*

### Service Definition
- **Isolation**: Each service gets its own directory (e.g., `dapps/new-service/`).
- **Container Name**: ALWAYS specify `container_name: <service_name>` for predictable DNS resolution.
- **Restart Policy**: `restart: unless-stopped` is standard.
- **Secrets**: Use `env_file: .env`. NEVER commit credentials to git.

### Networking (The "Hybrid" Strategy)
Traefik is the reverse proxy. Services are exposed in one of two ways:

**Method A: Dedicated Network (Preferred for new web apps)**
1. **App Config**: Define a named network in the app's `docker-compose.yml`.
   ```yaml
   networks:
     my-app-net:
       name: my-app-net
       driver: bridge
   ```
2. **Traefik Config**:
   - Update `infra/traefik/docker-compose.yaml`: Add `my-app-net` to the `traefik` container's networks and the top-level `networks` (as `external: true`).
   - Update `infra/traefik/config/dynamic/services.yaml`: Add the router and service definition, pointing to `http://container_name:port`.

**Method B: Host Networking (Legacy/Specific Use Cases)**
1. **App Config**: Map ports to the host (`ports: "8080:80"`).
2. **Traefik Config**:
   - Update `infra/traefik/config/dynamic/services.yaml`: Point the service URL to `http://host.docker.internal:8080`.

### Storage & Volumes
- **Config**: Use bind mounts relative to the compose file for configuration.
  - Example: `- ./config:/config`
- **Data**: Use absolute paths for heavy data (Media, Downloads).
  - Convention: `/DATA/...` (or check existing mounts in `SERVER_SETUP_GUIDE.md`).
- **Permissions**: Be mindful of PID/GID. `user: "1000:1000"` is often safe for this setup.

## 4. Deployment & Verification Commands

### Verification
- **Lint Config**: Check syntax before applying.
  ```bash
  docker compose config
  ```
- **Check Conflicts**: Ensure exposed ports don't clash with existing services.
  ```bash
  docker ps --format "table {{.Names}}\t{{.Ports}}"
  ```

### Deployment
- **Deploy App**:
  ```bash
  docker compose -f dapps/<app>/docker-compose.yml up -d
  ```
- **Update Traefik** (Required if adding a new network):
  ```bash
  docker compose -f infra/traefik/docker-compose.yml up -d
  ```

## 5. Adding a New Service Checklist
1. [ ] Create `dapps/<service>/docker-compose.yml`.
2. [ ] configure `container_name` and volumes.
3. [ ] Define network (Method A) or Ports (Method B).
4. [ ] Create `.env.example` if variables are needed.
5. [ ] Register service in `infra/traefik/config/dynamic/services.yaml`.
6. [ ] (Method A only) Register network in `infra/traefik/docker-compose.yaml`.
7. [ ] Test with `docker compose up -d`.

---
*Generated by Antigravity on Mon Jan 26 2026*
